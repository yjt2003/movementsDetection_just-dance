<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreeDance - è‡ªç”±èˆè¹ˆæ¨¡å¼</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* é©¬å¡é¾™è‰²å½©ç³»ç»Ÿ */
            --macaron-pink: #FFB5BA;
            --macaron-mint: #B5E5CF;
            --macaron-lemon: #FFF4B5;
            --macaron-lavender: #D4B5FF;
            --macaron-peach: #FFD4B5;
            --macaron-sky: #B5D4FF;

            /* ä¸­æ€§è‰² */
            --white: #FFFFFF;
            --light-gray: #F8F9FA;
            --gray: #E9ECEF;
            --dark-gray: #6C757D;
            --black: #212529;

            /* æ¸å˜ */
            --gradient-main: linear-gradient(135deg, var(--macaron-pink) 0%, var(--macaron-mint) 100%);
            --gradient-score: linear-gradient(135deg, var(--macaron-lemon) 0%, var(--macaron-peach) 100%);
            --gradient-perfect: linear-gradient(135deg, var(--macaron-lavender) 0%, var(--macaron-sky) 100%);
            --gradient-energy: linear-gradient(90deg, var(--macaron-lemon) 0%, var(--macaron-peach) 50%, var(--macaron-pink) 100%);
            --gradient-cosmic: linear-gradient(135deg, var(--macaron-pink) 0%, var(--macaron-lavender) 50%, var(--macaron-sky) 100%);

            /* é˜´å½± */
            --shadow-soft: 0 8px 32px rgba(255, 181, 186, 0.15);
            --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --shadow-glow: 0 0 30px rgba(255, 181, 186, 0.3);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--black);
        }

        /* åŠ¨æ€èƒŒæ™¯ç²’å­æ•ˆæœ */
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--macaron-pink);
            border-radius: 50%;
            animation: float 6s infinite ease-in-out;
            opacity: 0.6;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-80px) rotate(180deg); opacity: 0.8; }
        }

        /* é¡¶éƒ¨å¯¼èˆª - é©¬å¡é¾™é£æ ¼ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-soft);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo i {
            color: var(--macaron-pink);
            margin-right: 0.5rem;
        }

        .mode-indicator {
            background: var(--gradient-cosmic);
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            color: white;
            box-shadow: var(--shadow-card);
            animation: gentle-pulse 3s infinite;
        }

        @keyframes gentle-pulse {
            0%, 100% { box-shadow: var(--shadow-card); }
            50% { box-shadow: var(--shadow-hover); }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .score-display {
            background: var(--gradient-score);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            color: var(--black);
            box-shadow: var(--shadow-card);
        }

        .back-btn {
            background: var(--gradient-perfect);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-card);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            display: flex;
            gap: 2rem;
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 80px);
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .control-panel {
            width: 350px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .control-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
            transition: all 0.3s ease;
        }

        .control-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title i {
            color: var(--macaron-pink);
        }

        /* éŸ³ä¹é€‰æ‹© */
        .music-selector {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .music-option {
            background: var(--light-gray);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .music-option:hover {
            background: rgba(255, 181, 186, 0.1);
            transform: scale(1.02);
        }

        .music-option.active {
            background: var(--gradient-main);
            border-color: var(--macaron-pink);
            color: white;
            box-shadow: var(--shadow-card);
        }

        .music-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .music-info {
            flex: 1;
        }

        .music-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .music-bpm {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* æ¸¸æˆæ§åˆ¶ */
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .control-button {
            background: var(--gradient-main);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-card);
        }

        .control-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .control-button:disabled {
            background: var(--gray);
            color: var(--dark-gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .control-button.stop {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
        }

        .control-button.pause {
            background: var(--gradient-score);
            color: var(--black);
        }

        /* éš¾åº¦é€‰æ‹©å™¨ */
        .difficulty-selector {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* ä¸­é—´è§†é¢‘åŒºåŸŸ */
        .video-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .video-container {
            background: white;
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .video-container:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .video-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--black);
            background: var(--gradient-main);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: var(--macaron-mint);
            color: var(--black);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .video-frame {
            width: 100%;
            height: 500px;
            background: var(--light-gray);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border: 2px solid var(--macaron-sky);
        }

        .video-placeholder {
            color: var(--dark-gray);
            font-size: 1.1rem;
            text-align: center;
        }

        .video-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--macaron-pink);
            opacity: 0.7;
        }

        .video-display {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        #userVideo {
            transform: scaleX(-1);
        }

        /* æŒ‘æˆ˜åŒºåŸŸ */
        .challenge-area {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: var(--shadow-card);
            border: 2px solid var(--macaron-mint);
        }

        .current-challenge {
            text-align: center;
        }

        .challenge-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            animation: gentle-bounce 2s infinite;
        }

        @keyframes gentle-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .challenge-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .challenge-timer {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-score);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* å³ä¾§çŠ¶æ€é¢æ¿ */
        .status-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* èƒ½é‡æ¡ */
        .energy-meter {
            text-align: center;
        }

        .energy-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--gradient-energy) 0deg, var(--gray) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            position: relative;
            box-shadow: var(--shadow-card);
        }

        .energy-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--black);
        }

        .energy-label {
            color: var(--dark-gray);
            font-weight: 600;
        }

        /* è¿å‡»æ˜¾ç¤º */
        .combo-display {
            text-align: center;
            background: var(--gradient-perfect);
            border-radius: 20px;
            padding: 1.5rem;
            color: white;
            box-shadow: var(--shadow-card);
        }

        .combo-number {
            font-size: 3rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .combo-label {
            font-size: 1.1rem;
            font-weight: 600;
            opacity: 0.9;
        }

        /* å®æ—¶è¯„åˆ† */
        .score-breakdown {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--light-gray);
            padding: 0.75rem;
            border-radius: 15px;
            border-left: 4px solid var(--macaron-pink);
        }

        .score-name {
            font-weight: 500;
            color: var(--black);
        }

        .score-value {
            font-weight: 700;
            font-size: 1.1rem;
            background: var(--gradient-score);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-bar {
            width: 100%;
            height: 6px;
            background: var(--gray);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .score-fill {
            height: 100%;
            background: var(--gradient-main);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* åŠ¨ä½œå†å² */
        .move-history {
            max-height: 200px;
            overflow-y: auto;
        }

        .move-item {
            background: var(--light-gray);
            padding: 0.75rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 3px solid var(--macaron-mint);
            transition: all 0.2s ease;
        }

        .move-item:hover {
            background: rgba(181, 229, 207, 0.2);
        }

        .move-icon {
            font-size: 1.2rem;
            color: var(--macaron-mint);
        }

        .move-name {
            flex: 1;
            font-weight: 500;
            color: var(--black);
        }

        .move-score {
            font-weight: 600;
            background: var(--gradient-score);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ç‰¹æ•ˆ */
        .perfect-explosion {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: 800;
            background: var(--gradient-perfect);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            pointer-events: none;
            animation: gentle-explode 2s ease-out forwards;
            z-index: 1000;
        }

        @keyframes gentle-explode {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0);
            }
            30% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.5) translateY(-80px);
            }
        }

        /* è¿å‡»ç‰¹æ•ˆ */
        .combo-effect {
            position: absolute;
            top: 20%;
            right: 10%;
            font-size: 1.8rem;
            font-weight: 800;
            background: var(--gradient-cosmic);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            pointer-events: none;
            animation: gentle-combo-pop 1.5s ease-out forwards;
            z-index: 999;
        }

        @keyframes gentle-combo-pop {
            0% {
                opacity: 0;
                transform: scale(0) rotate(-90deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.1) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: scale(1) rotate(90deg) translateX(50px);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
                padding: 1rem;
            }
            
            .control-panel,
            .status-panel {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .control-card {
                flex: 1;
                min-width: 250px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .logo {
                font-size: 1.5rem;
            }
            
            .video-frame {
                height: 300px;
            }
            
            .control-panel,
            .status-panel {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- åŠ¨æ€èƒŒæ™¯ç²’å­ -->
    <div class="background-particles" id="particles"></div>

    <div class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-heart"></i> FreeDance
            </div>
            <div class="mode-indicator">
                <i class="fas fa-sparkles"></i> è‡ªç”±èˆè¹ˆæ¨¡å¼
            </div>
            <div class="header-controls">
                <div class="score-display">
                    <i class="fas fa-star"></i> <span id="totalScore">0</span>
                </div>
                <button class="back-btn" id="backToReference">
                    <i class="fas fa-arrow-left"></i> è¿”å›
                </button>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <!-- éŸ³ä¹é€‰æ‹© -->
                <div class="control-card">
                    <h3 class="card-title">
                        <i class="fas fa-music"></i> é€‰æ‹©éŸ³ä¹
                    </h3>
                    <div class="music-selector" id="musicSelector">
                        <!-- éŸ³ä¹é€‰é¡¹å°†ç”±JSç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ¸¸æˆæ§åˆ¶ -->
                <div class="control-card">
                    <h3 class="card-title">
                        <i class="fas fa-gamepad"></i> æ§åˆ¶
                    </h3>
                    <div class="game-controls">
                        <button class="control-button" id="startFreeDance">
                            <i class="fas fa-play"></i> å¼€å§‹èˆè¹ˆ
                        </button>
                        <button class="control-button pause" id="pauseFreeDance" style="display: none;">
                            <i class="fas fa-pause"></i> æš‚åœ
                        </button>
                        <button class="control-button" id="resumeFreeDance" style="display: none;">
                            <i class="fas fa-play"></i> ç»§ç»­
                        </button>
                        <button class="control-button stop" id="stopFreeDance" style="display: none;">
                            <i class="fas fa-stop"></i> ç»“æŸ
                        </button>
                    </div>
                </div>

                <!-- æŒ‘æˆ˜è®¾ç½® -->
                <div class="control-card">
                    <h3 class="card-title">
                        <i class="fas fa-target"></i> æŒ‘æˆ˜éš¾åº¦
                    </h3>
                    <div class="challenge-settings">
                        <div class="difficulty-selector" id="difficultySelector">
                            <!-- éš¾åº¦é€‰é¡¹å°†ç”±JSç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´è§†é¢‘åŒºåŸŸ -->
            <div class="video-section">
                <!-- æ‘„åƒå¤´æ˜¾ç¤º -->
                <div class="video-container">
                    <div class="video-header">
                        <h3 class="video-title">
                            <i class="fas fa-camera"></i> ä½ çš„èˆå°
                        </h3>
                        <div class="status-indicator" id="cameraStatus">
                            <i class="fas fa-circle" style="color: var(--macaron-mint);"></i>
                            <span>æ‘„åƒå¤´å°±ç»ª</span>
                        </div>
                    </div>

                    <div class="video-frame" style="position: relative;">
                        <div class="video-placeholder" id="cameraPlaceholder">
                            <i class="fas fa-camera-slash"></i>
                            <p>å¯åŠ¨æ‘„åƒå¤´ä¸­...</p>
                        </div>

                        <video id="userVideo" class="video-display" autoplay muted playsinline style="display:none;"></video>

                        <!-- ç‰¹æ•ˆå®¹å™¨ -->
                        <div id="effectsContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;"></div>
                    </div>
                </div>

                <!-- å½“å‰æŒ‘æˆ˜æ˜¾ç¤º -->
                <div class="challenge-area">
                    <div class="current-challenge">
                        <div class="challenge-icon" id="challengeIcon">ğŸŒ¸</div>
                        <div class="challenge-text" id="challengeText">å‡†å¤‡å¥½å¼€å§‹è‡ªç”±èˆè¹ˆï¼</div>
                        <div class="challenge-timer" id="challengeTimer">--</div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§çŠ¶æ€é¢æ¿ -->
            <div class="status-panel">
                <!-- èƒ½é‡æ¡ -->
                <div class="control-card">
                    <h3 class="card-title">
                        <i class="fas fa-heart"></i> èƒ½é‡å€¼
                    </h3>
                    <div class="energy-meter">
                        <div class="energy-circle" id="energyCircle">
                            <div class="energy-value" id="energyValue">0%</div>
                        </div>
                        <div class="energy-label">èˆè¹ˆèƒ½é‡</div>
                    </div>
                </div>

                <!-- è¿å‡»æ˜¾ç¤º -->
                <div class="control-card">
                    <div class="combo-display">
                        <div class="combo-number" id="comboNumber">0</div>
                        <div class="combo-label">COMBO</div>
                    </div>
                </div>

                <!-- å®æ—¶è¯„åˆ† -->
                <div class="control-card">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i> å®æ—¶è¯„åˆ†
                    </h3>
                    <div class="score-breakdown">
                        <div class="score-item">
                            <span class="score-name">æµç•…åº¦</span>
                            <span class="score-value" id="fluidityScore">0</span>
                        </div>
                        <div class="score-bar">
                            <div class="score-fill" id="fluidityBar"></div>
                        </div>
                        
                        <div class="score-item">
                            <span class="score-name">èŠ‚å¥æ„Ÿ</span>
                            <span class="score-value" id="rhythmScore">0</span>
                        </div>
                        <div class="score-bar">
                            <div class="score-fill" id="rhythmBar"></div>
                        </div>
                        
                        <div class="score-item">
                            <span class="score-name">åˆ›æ„åº¦</span>
                            <span class="score-value" id="creativityScore">0</span>
                        </div>
                        <div class="score-bar">
                            <div class="score-fill" id="creativityBar"></div>
                        </div>
                        
                        <div class="score-item">
                            <span class="score-name">æ´»è·ƒåº¦</span>
                            <span class="score-value" id="activityScore">0</span>
                        </div>
                        <div class="score-bar">
                            <div class="score-fill" id="activityBar"></div>
                        </div>
                    </div>
                </div>

                <!-- åŠ¨ä½œå†å² -->
                <div class="control-card">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i> åŠ¨ä½œè®°å½•
                    </h3>
                    <div class="move-history" id="moveHistory">
                        <div class="move-item">
                            <div class="move-icon">ğŸŒŸ</div>
                            <div class="move-name">å‡†å¤‡å¼€å§‹</div>
                            <div class="move-score">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // FreeDance åº”ç”¨çŠ¶æ€
        let freeDanceState = {
            // è¿æ¥çŠ¶æ€
            wsConnected: false,
            cameraReady: false,
            ws: null,

            // æ¸¸æˆçŠ¶æ€
            gameStarted: false,
            gamePaused: false,
            gameStartTime: null,
            currentChallenge: null,
            
            // éŸ³ä¹å’Œéš¾åº¦
            selectedMusic: null,
            selectedDifficulty: 'normal',
            
            // è¯„åˆ†æ•°æ®
            scores: {
                fluidity: 0,
                rhythm: 0,
                creativity: 0,
                activity: 0,
                total: 0
            },
            
            // æ¸¸æˆæœºåˆ¶
            energy: 0,
            combo: 0,
            maxCombo: 0,
            totalScore: 0,
            
            // åŠ¨ä½œæ£€æµ‹
            lastPoseData: null,
            moveHistory: [],
            challengeTimer: null,
            
            // éŸ³ä¹èŠ‚æ‹
            beatTimes: [],
            currentBeat: 0
        };

        // éŸ³ä¹é€‰é¡¹
        const musicOptions = [
            { id: 1, name: 'Sweet Pop', bpm: 128, icon: 'ğŸµ', genre: 'Pop' },
            { id: 2, name: 'Gentle Beats', bpm: 95, icon: 'ğŸ¤', genre: 'Hip-Hop' },
            { id: 3, name: 'Dream Dance', bpm: 140, icon: 'âœ¨', genre: 'EDM' },
            { id: 4, name: 'Soft Groove', bpm: 110, icon: 'ğŸŒ¸', genre: 'Funk' },
            { id: 5, name: 'Pastel Vibes', bpm: 120, icon: 'ğŸ’–', genre: 'Latin' }
        ];

        // éš¾åº¦é€‰é¡¹
        const difficultyOptions = [
            { id: 'easy', name: 'è½»æ¾', color: 'var(--macaron-mint)', multiplier: 1.0 },
            { id: 'normal', name: 'æ ‡å‡†', color: 'var(--macaron-lemon)', multiplier: 1.2 },
            { id: 'hard', name: 'å›°éš¾', color: 'var(--macaron-peach)', multiplier: 1.5 },
            { id: 'expert', name: 'ä¸“å®¶', color: 'var(--macaron-lavender)', multiplier: 2.0 }
        ];

        // æŒ‘æˆ˜ç±»å‹
        const challengeTypes = [
            { name: 'è‡ªç”±èˆè¹ˆ', icon: 'ğŸŒ¸', description: 'å°½æƒ…é‡Šæ”¾ä½ çš„èˆè¹ˆå¤©èµ‹ï¼', duration: 30 },
            { name: 'æ¸©æŸ”å¾‹åŠ¨', icon: 'ğŸ’«', description: 'å±•ç¤ºä½ çš„ä¼˜é›…åŠ¨ä½œï¼', duration: 15 },
            { name: 'èŠ‚å¥å¤©ä½¿', icon: 'ğŸµ', description: 'è·Ÿä¸ŠèŠ‚æ‹ï¼Œå±•ç°èŠ‚å¥æ„Ÿï¼', duration: 20 },
            { name: 'åˆ›æ„èŠ±å›­', icon: 'ğŸŒº', description: 'å‘æŒ¥åˆ›æ„ï¼Œåšå‡ºç‹¬ç‰¹åŠ¨ä½œï¼', duration: 25 },
            { name: 'ç”œèœœè¿å‡»', icon: 'ğŸ’–', description: 'ä¿æŒè¿å‡»ï¼Œè·å¾—é«˜åˆ†ï¼', duration: 30 }
        ];

        // DOM å…ƒç´ 
        const elements = {
            // æ§åˆ¶å…ƒç´ 
            musicSelector: document.getElementById('musicSelector'),
            difficultySelector: document.getElementById('difficultySelector'),
            startFreeDance: document.getElementById('startFreeDance'),
            pauseFreeDance: document.getElementById('pauseFreeDance'),
            resumeFreeDance: document.getElementById('resumeFreeDance'),
            stopFreeDance: document.getElementById('stopFreeDance'),
            backToReference: document.getElementById('backToReference'),
            
            // è§†é¢‘å…ƒç´ 
            userVideo: document.getElementById('userVideo'),
            cameraPlaceholder: document.getElementById('cameraPlaceholder'),
            cameraStatus: document.getElementById('cameraStatus'),
            
            // æŒ‘æˆ˜æ˜¾ç¤º
            challengeIcon: document.getElementById('challengeIcon'),
            challengeText: document.getElementById('challengeText'),
            challengeTimer: document.getElementById('challengeTimer'),
            
            // è¯„åˆ†æ˜¾ç¤º
            totalScore: document.getElementById('totalScore'),
            energyValue: document.getElementById('energyValue'),
            energyCircle: document.getElementById('energyCircle'),
            comboNumber: document.getElementById('comboNumber'),
            
            // åˆ†æ•°æ¡
            fluidityScore: document.getElementById('fluidityScore'),
            rhythmScore: document.getElementById('rhythmScore'),
            creativityScore: document.getElementById('creativityScore'),
            activityScore: document.getElementById('activityScore'),
            fluidityBar: document.getElementById('fluidityBar'),
            rhythmBar: document.getElementById('rhythmBar'),
            creativityBar: document.getElementById('creativityBar'),
            activityBar: document.getElementById('activityBar'),
            
            // å†å²è®°å½•
            moveHistory: document.getElementById('moveHistory'),
            effectsContainer: document.getElementById('effectsContainer')
        };

        // åˆå§‹åŒ–åº”ç”¨
        function initFreeDanceApp() {
            console.log('ğŸŒ¸ FreeDance é©¬å¡é¾™æ¨¡å¼åˆå§‹åŒ–');
            createBackgroundParticles();
            initMusicSelector();
            initDifficultySelector();
            initWebSocket();
            initEventListeners();
            initCamera();
        }

        // åˆ›å»ºèƒŒæ™¯ç²’å­æ•ˆæœ
        function createBackgroundParticles() {
            const container = document.getElementById('particles');
            const colors = ['var(--macaron-pink)', 'var(--macaron-mint)', 'var(--macaron-lemon)', 'var(--macaron-lavender)'];
            
            for (let i = 0; i < 40; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                container.appendChild(particle);
            }
        }

        // åˆå§‹åŒ–éŸ³ä¹é€‰æ‹©å™¨
        function initMusicSelector() {
            elements.musicSelector.innerHTML = '';
            musicOptions.forEach((music, index) => {
                const option = document.createElement('div');
                option.className = 'music-option';
                if (index === 0) {
                    option.classList.add('active');
                    freeDanceState.selectedMusic = music;
                }
                
                option.innerHTML = `
                    <div class="music-icon">${music.icon}</div>
                    <div class="music-info">
                        <div class="music-name">${music.name}</div>
                        <div class="music-bpm">${music.bpm} BPM â€¢ ${music.genre}</div>
                    </div>
                `;
                
                option.addEventListener('click', () => selectMusic(music, option));
                elements.musicSelector.appendChild(option);
            });
        }

        // åˆå§‹åŒ–éš¾åº¦é€‰æ‹©å™¨
        function initDifficultySelector() {
            elements.difficultySelector.innerHTML = '';
            difficultyOptions.forEach(difficulty => {
                const option = document.createElement('div');
                option.className = 'music-option';
                option.style.borderColor = difficulty.color;
                
                if (difficulty.id === freeDanceState.selectedDifficulty) {
                    option.classList.add('active');
                }
                
                option.innerHTML = `
                    <div class="music-icon" style="color: ${difficulty.color}">â­</div>
                    <div class="music-info">
                        <div class="music-name">${difficulty.name}</div>
                        <div class="music-bpm">Ã—${difficulty.multiplier} åˆ†æ•°å€ç‡</div>
                    </div>
                `;
                
                option.addEventListener('click', () => selectDifficulty(difficulty, option));
                elements.difficultySelector.appendChild(option);
            });
        }

        // é€‰æ‹©éŸ³ä¹
        function selectMusic(music, element) {
            freeDanceState.selectedMusic = music;
            
            // ç”ŸæˆèŠ‚æ‹æ—¶é—´ï¼ˆæ¨¡æ‹Ÿï¼‰
            freeDanceState.beatTimes = [];
            const beatInterval = 60 / music.bpm; // ç§’
            for (let i = 0; i < 200; i++) {
                freeDanceState.beatTimes.push(i * beatInterval);
            }
            
            document.querySelectorAll('.music-option').forEach(opt => opt.classList.remove('active'));
            element.classList.add('active');
            
            console.log(`ğŸµ é€‰æ‹©éŸ³ä¹: ${music.name} (${music.bpm} BPM)`);
        }

        // é€‰æ‹©éš¾åº¦
        function selectDifficulty(difficulty, element) {
            freeDanceState.selectedDifficulty = difficulty.id;
            
            document.querySelectorAll('#difficultySelector .music-option').forEach(opt => opt.classList.remove('active'));
            element.classList.add('active');
            
            console.log(`â­ é€‰æ‹©éš¾åº¦: ${difficulty.name} (Ã—${difficulty.multiplier})`);
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/ws`;
                
                freeDanceState.ws = new WebSocket(wsUrl);
                
                freeDanceState.ws.onopen = () => {
                    console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    freeDanceState.wsConnected = true;
                };
                
                freeDanceState.ws.onclose = () => {
                    console.log('âŒ WebSocketè¿æ¥æ–­å¼€');
                    freeDanceState.wsConnected = false;
                    setTimeout(initWebSocket, 5000);
                };
                
                freeDanceState.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('WebSocketæ¶ˆæ¯è§£æå¤±è´¥:', e);
                    }
                };
            } catch (error) {
                console.error('WebSocketåˆå§‹åŒ–å¤±è´¥:', error);
                setTimeout(initWebSocket, 5000);
            }
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            const eventType = data.event || data.type;
            
            switch (eventType) {
                case 'frame_result':
                    handleFrameResult(data);
                    break;
                case 'score_update':
                    handleScoreUpdate(data);
                    break;
                case 'game_started':
                    freeDanceState.gameStarted = true;
                    updateGameControls();
                    break;
                case 'game_stopped':
                    freeDanceState.gameStarted = false;
                    freeDanceState.gamePaused = false;
                    updateGameControls();
                    break;
            }
        }

        // å¤„ç†å¸§ç»“æœ
        function handleFrameResult(data) {
            if (data.type === 'webcam' && freeDanceState.gameStarted) {
                // åˆ†æåŠ¨ä½œå¹¶ç”Ÿæˆè¯„åˆ†
                analyzeMovement(data);
            }
        }

        // å¤„ç†è¯„åˆ†æ›´æ–°
        function handleScoreUpdate(data) {
            if (data.current_scores) {
                updateFreeDanceScores(data.current_scores);
            }
        }

        // åˆ†æåŠ¨ä½œ - FreeDanceç‰¹æœ‰é€»è¾‘
        function analyzeMovement(frameData) {
            if (!freeDanceState.gameStarted || freeDanceState.gamePaused) return;
            
            // æ¨¡æ‹ŸåŠ¨ä½œåˆ†æå’Œè¯„åˆ†
            const currentTime = Date.now();
            
            // ç”Ÿæˆéšæœºä½†åˆç†çš„åˆ†æ•°
            const fluidity = Math.random() * 40 + 60; // 60-100
            const rhythm = calculateRhythmScore(currentTime);
            const creativity = Math.random() * 50 + 50; // 50-100
            const activity = Math.random() * 30 + 70; // 70-100
            
            // æ›´æ–°åˆ†æ•°
            freeDanceState.scores = {
                fluidity: fluidity,
                rhythm: rhythm,
                creativity: creativity,
                activity: activity,
                total: (fluidity + rhythm + creativity + activity) / 4
            };
            
            // æ£€æŸ¥æ˜¯å¦è§¦å‘ç‰¹æ•ˆ
            checkForSpecialEffects();
            
            // æ›´æ–°UI
            updateScoreDisplay();
            updateEnergyAndCombo();
            addMoveToHistory();
        }

        // è®¡ç®—èŠ‚å¥åˆ†æ•°
        function calculateRhythmScore(currentTime) {
            if (!freeDanceState.beatTimes.length) return Math.random() * 40 + 30;
            
            const gameTime = (currentTime - freeDanceState.gameStartTime) / 1000;
            const closestBeat = freeDanceState.beatTimes.find(beat => Math.abs(beat - gameTime) < 0.3);
            
            if (closestBeat) {
                const timeDiff = Math.abs(closestBeat - gameTime);
                return Math.max(0, 100 - timeDiff * 200); // è¶Šæ¥è¿‘èŠ‚æ‹åˆ†æ•°è¶Šé«˜
            }
            
            return Math.random() * 60 + 20; // 20-80 éšæœºåˆ†
        }

        // æ£€æŸ¥ç‰¹æ•ˆè§¦å‘
        function checkForSpecialEffects() {
            const totalScore = freeDanceState.scores.total;
            
            // å®Œç¾åŠ¨ä½œç‰¹æ•ˆ
            if (totalScore > 95) {
                triggerPerfectEffect();
                freeDanceState.combo++;
            } else if (totalScore > 80) {
                freeDanceState.combo++;
            } else {
                freeDanceState.combo = 0;
            }
            
            // è¿å‡»ç‰¹æ•ˆ
            if (freeDanceState.combo > 0 && freeDanceState.combo % 5 === 0) {
                triggerComboEffect();
            }
            
            // æ›´æ–°æœ€å¤§è¿å‡»
            freeDanceState.maxCombo = Math.max(freeDanceState.maxCombo, freeDanceState.combo);
        }

        // è§¦å‘å®Œç¾ç‰¹æ•ˆ
        function triggerPerfectEffect() {
            const effect = document.createElement('div');
            effect.className = 'perfect-explosion';
            effect.innerHTML = 'ğŸŒŸ PERFECT! ğŸŒŸ';
            elements.effectsContainer.appendChild(effect);
            
            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 2000);
        }

        // è§¦å‘è¿å‡»ç‰¹æ•ˆ
        function triggerComboEffect() {
            const effect = document.createElement('div');
            effect.className = 'combo-effect';
            effect.innerHTML = `ğŸ’– ${freeDanceState.combo} COMBO! ğŸ’–`;
            elements.effectsContainer.appendChild(effect);
            
            setTimeout(() => {
                if (effect.parentNode) {
                    effect.parentNode.removeChild(effect);
                }
            }, 1500);
        }

        // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
        function updateScoreDisplay() {
            const scores = freeDanceState.scores;
            
            elements.fluidityScore.textContent = Math.round(scores.fluidity);
            elements.rhythmScore.textContent = Math.round(scores.rhythm);
            elements.creativityScore.textContent = Math.round(scores.creativity);
            elements.activityScore.textContent = Math.round(scores.activity);
            
            elements.fluidityBar.style.width = `${scores.fluidity}%`;
            elements.rhythmBar.style.width = `${scores.rhythm}%`;
            elements.creativityBar.style.width = `${scores.creativity}%`;
            elements.activityBar.style.width = `${scores.activity}%`;
            
            // æ›´æ–°æ€»åˆ†
            freeDanceState.totalScore += scores.total / 10; // ç´¯åŠ åˆ†æ•°
            elements.totalScore.textContent = Math.round(freeDanceState.totalScore);
        }

        // æ›´æ–°èƒ½é‡å’Œè¿å‡»
        function updateEnergyAndCombo() {
            // èƒ½é‡å€¼åŸºäºæ€»ä½“è¡¨ç°
            freeDanceState.energy = Math.min(100, freeDanceState.scores.total);
            elements.energyValue.textContent = Math.round(freeDanceState.energy) + '%';
            
            // æ›´æ–°èƒ½é‡åœ†ç¯
            const angle = (freeDanceState.energy / 100) * 360;
            elements.energyCircle.style.background = `conic-gradient(var(--gradient-energy) ${angle}deg, var(--gray) ${angle}deg)`;
            
            // æ›´æ–°è¿å‡»æ˜¾ç¤º
            elements.comboNumber.textContent = freeDanceState.combo;
        }

        // æ·»åŠ åŠ¨ä½œåˆ°å†å²
        function addMoveToHistory() {
            const moveNames = ['ä¼˜é›…è½¬èº«', 'æ¸©æŸ”è·³è·ƒ', 'æµç•…æ‘†è‡‚', 'ç”œç¾è¸æ­¥', 'åˆ›æ„åŠ¨ä½œ', 'èƒ½é‡ç»½æ”¾'];
            const randomMove = moveNames[Math.floor(Math.random() * moveNames.length)];
            const score = Math.round(freeDanceState.scores.total);
            
            const moveItem = document.createElement('div');
            moveItem.className = 'move-item';
            moveItem.innerHTML = `
                <div class="move-icon">ğŸŒŸ</div>
                <div class="move-name">${randomMove}</div>
                <div class="move-score">${score}</div>
            `;
            
            elements.moveHistory.insertBefore(moveItem, elements.moveHistory.firstChild);
            
            // ä¿æŒæœ€å¤š10ä¸ªè®°å½•
            while (elements.moveHistory.children.length > 10) {
                elements.moveHistory.removeChild(elements.moveHistory.lastChild);
            }
        }

        // åˆå§‹åŒ–æ‘„åƒå¤´
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user',
                        frameRate: { ideal: 15 }
                    }
                });
                
                elements.userVideo.srcObject = stream;
                freeDanceState.cameraReady = true;
                
                elements.userVideo.onloadedmetadata = () => {
                    elements.userVideo.play().then(() => {
                        elements.cameraPlaceholder.style.display = 'none';
                        elements.userVideo.style.display = 'block';
                        startVideoCapture();
                    });
                };
                
            } catch (error) {
                console.error('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', error);
                elements.cameraPlaceholder.innerHTML = `
                    <i class="fas fa-camera-slash"></i>
                    <p>æ‘„åƒå¤´è·å–å¤±è´¥</p>
                    <button onclick="initCamera()" class="control-button" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 0.9rem;">
                        <i class="fas fa-redo"></i> é‡è¯•
                    </button>
                `;
            }
        }

        // å¼€å§‹è§†é¢‘æ•è·
        function startVideoCapture() {
            if (!elements.userVideo || !freeDanceState.wsConnected) {
                return;
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            let lastCaptureTime = 0;
            const captureInterval = 100; // 10FPS ç”¨äºFreeDanceæ¨¡å¼
            
            const captureFrame = () => {
                if (!freeDanceState.cameraReady || !freeDanceState.wsConnected) {
                    return;
                }
                
                const now = Date.now();
                if (now - lastCaptureTime < captureInterval) {
                    requestAnimationFrame(captureFrame);
                    return;
                }
                lastCaptureTime = now;
                
                const videoWidth = elements.userVideo.videoWidth || 640;
                const videoHeight = elements.userVideo.videoHeight || 480;
                
                if (videoWidth === 0 || videoHeight === 0) {
                    requestAnimationFrame(captureFrame);
                    return;
                }
                
                canvas.width = videoWidth;
                canvas.height = videoHeight;
                
                try {
                    ctx.drawImage(elements.userVideo, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob((blob) => {
                        if (blob && freeDanceState.wsConnected) {
                            const reader = new FileReader();
                            reader.onload = () => {
                                // å‘é€FreeDanceç‰¹å®šçš„å¸§æ•°æ®
                                sendWebSocketMessage({
                                    event: 'frame',
                                    frame_type: 'freedance',
                                    image: reader.result,
                                    current_time: Date.now() / 1000,
                                    music_bpm: freeDanceState.selectedMusic?.bpm || 120,
                                    difficulty: freeDanceState.selectedDifficulty
                                });
                            };
                            reader.readAsDataURL(blob);
                        }
                    }, 'image/jpeg', 0.6);
                } catch (err) {
                    console.error('å¸§æ•è·é”™è¯¯:', err);
                }
                
                requestAnimationFrame(captureFrame);
            };
            
            captureFrame();
        }

        // å‘é€WebSocketæ¶ˆæ¯
        function sendWebSocketMessage(message) {
            if (freeDanceState.ws && freeDanceState.ws.readyState === WebSocket.OPEN) {
                freeDanceState.ws.send(JSON.stringify(message));
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // æ¸¸æˆæ§åˆ¶
            elements.startFreeDance.addEventListener('click', startFreeDanceGame);
            elements.pauseFreeDance.addEventListener('click', pauseFreeDanceGame);
            elements.resumeFreeDance.addEventListener('click', resumeFreeDanceGame);
            elements.stopFreeDance.addEventListener('click', stopFreeDanceGame);
            
            // è¿”å›æŒ‰é’®
            elements.backToReference.addEventListener('click', () => {
                if (freeDanceState.gameStarted) {
                    if (confirm('å½“å‰æ¸¸æˆæ­£åœ¨è¿›è¡Œï¼Œç¡®å®šè¦è¿”å›å—ï¼Ÿ')) {
                        window.location.href = 'dancevibe.html';
                    }
                } else {
                    window.location.href = 'dancevibe.html';
                }
            });
        }

        // å¼€å§‹FreeDanceæ¸¸æˆ
        function startFreeDanceGame() {
            if (!freeDanceState.selectedMusic) {
                alert('è¯·é€‰æ‹©éŸ³ä¹ï¼');
                return;
            }
            
            if (!freeDanceState.cameraReady) {
                alert('è¯·ç­‰å¾…æ‘„åƒå¤´å°±ç»ªï¼');
                return;
            }
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            freeDanceState.gameStarted = true;
            freeDanceState.gameStartTime = Date.now();
            freeDanceState.totalScore = 0;
            freeDanceState.combo = 0;
            freeDanceState.maxCombo = 0;
            freeDanceState.energy = 0;
            
            // å¼€å§‹æŒ‘æˆ˜å¾ªç¯
            startChallengeLoop();
            
            // å‘é€æ¸¸æˆå¼€å§‹æ¶ˆæ¯
            sendWebSocketMessage({
                event: 'start_game',
                mode: 'freedance',
                music: freeDanceState.selectedMusic,
                difficulty: freeDanceState.selectedDifficulty
            });
            
            updateGameControls();
            console.log('ğŸŒ¸ FreeDanceæ¸¸æˆå¼€å§‹ï¼');
        }

        // æš‚åœæ¸¸æˆ
        function pauseFreeDanceGame() {
            freeDanceState.gamePaused = true;
            clearTimeout(freeDanceState.challengeTimer);
            updateGameControls();
        }

        // æ¢å¤æ¸¸æˆ
        function resumeFreeDanceGame() {
            freeDanceState.gamePaused = false;
            startChallengeLoop();
            updateGameControls();
        }

        // åœæ­¢æ¸¸æˆ
        function stopFreeDanceGame() {
            freeDanceState.gameStarted = false;
            freeDanceState.gamePaused = false;
            clearTimeout(freeDanceState.challengeTimer);
            
            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            showFreeDanceResult();
            
            sendWebSocketMessage({ event: 'stop_game' });
            updateGameControls();
        }

        // å¼€å§‹æŒ‘æˆ˜å¾ªç¯
        function startChallengeLoop() {
            if (!freeDanceState.gameStarted || freeDanceState.gamePaused) return;
            
            // éšæœºé€‰æ‹©æŒ‘æˆ˜
            const challenge = challengeTypes[Math.floor(Math.random() * challengeTypes.length)];
            freeDanceState.currentChallenge = challenge;
            
            // æ›´æ–°æŒ‘æˆ˜æ˜¾ç¤º
            elements.challengeIcon.textContent = challenge.icon;
            elements.challengeText.textContent = challenge.description;
            
            // å¼€å§‹å€’è®¡æ—¶
            let timeLeft = challenge.duration;
            elements.challengeTimer.textContent = timeLeft;
            
            const countdown = setInterval(() => {
                timeLeft--;
                elements.challengeTimer.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    // å¼€å§‹ä¸‹ä¸€ä¸ªæŒ‘æˆ˜
                    freeDanceState.challengeTimer = setTimeout(startChallengeLoop, 2000);
                }
            }, 1000);
        }

        // æ˜¾ç¤ºFreeDanceç»“æœ
        function showFreeDanceResult() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                color: var(--black);
                font-family: 'Poppins', sans-serif;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 3rem; border-radius: 25px; text-align: center; max-width: 500px; box-shadow: var(--shadow-soft);">
                    <h2 style="font-size: 2.5rem; margin-bottom: 1rem; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ğŸŒ¸ èˆè¹ˆå®Œæˆï¼</h2>
                    <div style="font-size: 4rem; font-weight: 800; background: var(--gradient-score); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 1rem 0;">${Math.round(freeDanceState.totalScore)}</div>
                    <div style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--dark-gray);">æ€»å¾—åˆ†</div>
                    <div style="margin: 2rem 0; color: var(--black);">
                        <div>æœ€é«˜è¿å‡»: ${freeDanceState.maxCombo}</div>
                        <div>å¹³å‡èƒ½é‡: ${Math.round(freeDanceState.energy)}%</div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove(); startFreeDanceGame();" class="control-button">
                            <i class="fas fa-redo"></i> å†æ¥ä¸€æ¬¡
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove();" class="control-button">
                            <i class="fas fa-home"></i> è¿”å›
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // æ›´æ–°æ¸¸æˆæ§åˆ¶æŒ‰é’®
        function updateGameControls() {
            if (!freeDanceState.gameStarted) {
                elements.startFreeDance.style.display = 'block';
                elements.pauseFreeDance.style.display = 'none';
                elements.resumeFreeDance.style.display = 'none';
                elements.stopFreeDance.style.display = 'none';
            } else {
                elements.startFreeDance.style.display = 'none';
                elements.stopFreeDance.style.display = 'block';
                
                if (freeDanceState.gamePaused) {
                    elements.pauseFreeDance.style.display = 'none';
                    elements.resumeFreeDance.style.display = 'block';
                } else {
                    elements.pauseFreeDance.style.display = 'block';
                    elements.resumeFreeDance.style.display = 'none';
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initFreeDanceApp);
    </script>
</body>
</html>